# åŠŸèƒ½å®ç°è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†æ ¹æ®è¡¥å……èµ„æ–™å®ç°çš„æ‰€æœ‰åŠŸèƒ½ã€‚

## ğŸ“‹ ä¸šåŠ¡é€»è¾‘å®ç°

### 1. âœ… æ¨¡æ‹Ÿ 5 ä¸ªæ‚£è€…æ•°æ®

åˆ›å»ºäº† 5 ä¸ªçœŸå®çš„é¦™æ¸¯æ‚£è€…æ•°æ®ï¼ŒåŒ…å«å®Œæ•´ä¿¡æ¯ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| name | å§“åï¼ˆç¹ä½“ä¸­æ–‡ï¼‰ | é™ˆå¤§æ–‡ |
| email | é‚®ç®± | chen.dawen@example.com |
| phone | é¦™æ¸¯ç”µè¯ | +852 9123 4567 |
| age | å¹´é¾„ | 45 |
| gender | æ€§åˆ« | ç”·/å¥³ |
| id_card | é¦™æ¸¯èº«ä»½è¯ | H123456(7) |
| address | é¦™æ¸¯åœ°å€ | é¦™æ¸¯ä¹é¾æ—ºè§’å½Œæ•¦é“688è™Ÿ... |
| occupation | èŒä¸š | é‡‘èåˆ†æå¸« |
| medical_history | ç—…å² | é«˜è¡€å£“ç—…å²5å¹´... |

æ•°æ®ä½ç½®ï¼š
- **æœ¬åœ°æµ‹è¯•**ï¼š`lib/db-mock.ts`
- **ç”Ÿäº§ç¯å¢ƒ**ï¼š`sql/init.sql`

### 2. âœ… é‚®ç®±å’Œç”µè¯éªŒè¯

å®ç°æµç¨‹ï¼š
1. ç”¨æˆ·åœ¨ç™»å½•ç•Œé¢è¾“å…¥é‚®ç®±å’Œç”µè¯
2. å‰ç«¯å‘é€ POST è¯·æ±‚åˆ° `/api/verify`
3. API åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢åŒ¹é…çš„æ‚£è€…
4. éªŒè¯æˆåŠŸè¿”å› `patientId`
5. å‰ç«¯è·³è½¬åˆ° `/patient?id={patientId}`

å…³é”®ä»£ç ï¼š
```typescript
// pages/api/verify.ts
const patient = findPatientByEmailAndPhone(email, phone)
if (!patient) {
  return res.status(401).json({
    success: false,
    message: 'é‚®ç®±æˆ–ç”µè¯å·ç ä¸åŒ¹é…ï¼Œè¯·é‡è¯•'
  })
}
```

### 3. âœ… iframe é›†æˆ GPTBots Agent

æ ¹æ®è¡¥å……èµ„æ–™å®ç°äº†ä¸¤ç§æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆä¸€ï¼šURL å‚æ•°ä¼ é€’ user_id
```typescript
const baseUrl = 'https://www.gptbots.ai/widget/eek1z5tclbpvaoak5609epw/chat.html'
const userId = data.patient.email
setIframeUrl(`${baseUrl}?user_id=${encodeURIComponent(userId)}`)
```

**ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼Œç«‹å³ç”Ÿæ•ˆ

#### æ–¹æ¡ˆäºŒï¼špostMessage åŠ¨æ€è®¾ç½®ï¼ˆè¡¥å……æ–¹æ¡ˆï¼‰
```typescript
iframe.contentWindow.postMessage(
  JSON.stringify({ type: 'UserId', data: patientInfo.email }),
  '*'
)
```

**ä¼˜ç‚¹**ï¼šå¯ä»¥åœ¨ iframe åŠ è½½ååŠ¨æ€æ›´æ–°ä¿¡æ¯

### 4. âœ… æ‚£è€…ä¿¡æ¯ä¼ é€’åˆ° Agent

éªŒè¯é€šè¿‡åï¼Œç³»ç»Ÿæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **è·å–å®Œæ•´æ‚£è€…ä¿¡æ¯**
   ```typescript
   GET /api/patient?id={patientId}
   ```

2. **é€šè¿‡ URL ä¼ é€’ user_id**
   - iframe URL è‡ªåŠ¨åŒ…å« `?user_id={email}`
   - GPTBots ç³»ç»Ÿè¯†åˆ«è¯¥ç”¨æˆ·

3. **é€šè¿‡ postMessage å‘é€å±æ€§ï¼ˆå¯é€‰ï¼‰**
   ```javascript
   {
     name: "é™ˆå¤§æ–‡",
     email: "chen.dawen@example.com",
     phone: "+852 9123 4567",
     age: "45",
     gender: "ç”·",
     id_card: "H123456(7)",
     address: "é¦™æ¸¯ä¹é¾æ—ºè§’...",
     occupation: "é‡‘èåˆ†æå¸«",
     medical_history: "é«˜è¡€å£“ç—…å²5å¹´..."
   }
   ```

### 5. âœ… Agent å¯ä»¥è¯†åˆ«ç”¨æˆ·

æ ¹æ®è¡¥å……èµ„æ–™ä¸­çš„ç”¨æˆ·ä½“ç³»ï¼š

```
ç™»å½•éªŒè¯
    â†“
è·å– user_id (email)
    â†“
iframe URL: ?user_id=chen.dawen@example.com
    â†“
GPTBots è¯†åˆ«ç”¨æˆ·èº«ä»½
    â†“
Agent çŸ¥é“å½“å‰å¯¹è¯çš„æ‚£è€…ä¿¡æ¯
```

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ•°æ®åº“è‡ªåŠ¨åˆ‡æ¢

ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå¹¶é€‰æ‹©æ•°æ®æºï¼š

```typescript
const USE_REAL_DB = process.env.POSTGRES_URL ? true : false

if (USE_REAL_DB && sql) {
  // ä½¿ç”¨ Vercel Postgres
  const result = await sql`SELECT * FROM patients...`
} else {
  // ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®
  const patient = findPatientByEmailAndPhone(email, phone)
}
```

**æœ¬åœ°å¼€å‘**ï¼šæ— éœ€é…ç½®æ•°æ®åº“ï¼Œä½¿ç”¨ `lib/db-mock.ts`  
**Vercel éƒ¨ç½²**ï¼šè‡ªåŠ¨è¿æ¥ Vercel Postgres

### iframe å®‰å…¨è®¾ç½®

æ ¹æ®è¡¥å……èµ„æ–™é…ç½® iframeï¼š

```html
<iframe
  src="https://www.gptbots.ai/widget/eek1z5tclbpvaoak5609epw/chat.html?user_id=xxx"
  allow="microphone *"
  sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
/>
```

- `allow="microphone *"`ï¼šå…è®¸ä½¿ç”¨éº¦å…‹é£ï¼ˆè¯­éŸ³äº¤äº’ï¼‰
- `sandbox`ï¼šå®‰å…¨æ²™ç®±é…ç½®

### ç”¨æˆ·å±æ€§æ˜ å°„

| æ•°æ®åº“å­—æ®µ | Agent å±æ€§å | ç”¨é€” |
|-----------|-------------|------|
| email | user_id | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| name | name | æ‚£è€…å§“å |
| phone | phone | è”ç³»ç”µè¯ |
| age | age | å¹´é¾„ä¿¡æ¯ |
| gender | gender | æ€§åˆ« |
| id_card | id_card | èº«ä»½è¯å· |
| address | address | å±…ä½åœ°å€ |
| occupation | occupation | èŒä¸šä¿¡æ¯ |
| medical_history | medical_history | ç—…å²è®°å½• |

## ğŸ“Š API ç«¯ç‚¹

### POST /api/verify
éªŒè¯æ‚£è€…èº«ä»½

**è¯·æ±‚ï¼š**
```json
{
  "email": "chen.dawen@example.com",
  "phone": "+852 9123 4567"
}
```

**å“åº”ï¼ˆæˆåŠŸï¼‰ï¼š**
```json
{
  "success": true,
  "patientId": "1",
  "message": "éªŒè¯æˆåŠŸ"
}
```

**å“åº”ï¼ˆå¤±è´¥ï¼‰ï¼š**
```json
{
  "success": false,
  "message": "é‚®ç®±æˆ–ç”µè¯å·ç ä¸åŒ¹é…ï¼Œè¯·é‡è¯•"
}
```

### GET /api/patient?id={id}
è·å–æ‚£è€…å®Œæ•´ä¿¡æ¯

**å“åº”ï¼š**
```json
{
  "success": true,
  "patient": {
    "id": "1",
    "name": "é™ˆå¤§æ–‡",
    "email": "chen.dawen@example.com",
    "phone": "+852 9123 4567",
    "age": 45,
    "gender": "ç”·",
    "idCard": "H123456(7)",
    "address": "é¦™æ¸¯ä¹é¾æ—ºè§’å½Œæ•¦é“688è™Ÿæ—ºè§’ä¸­å¿ƒ15æ¨“Aå®¤",
    "occupation": "é‡‘èåˆ†æå¸«",
    "medicalHistory": "é«˜è¡€å£“ç—…å²5å¹´ï¼Œç›®å‰æœç”¨é™å£“è—¥æ§åˆ¶ï¼Œå¶æœ‰é ­æšˆç—‡ç‹€"
  }
}
```

## ğŸ¨ UI/UX ç‰¹æ€§

### ç™»å½•ç•Œé¢
- æ¸å˜ç´«è‰²èƒŒæ™¯
- å±…ä¸­ç™½è‰²å¡ç‰‡
- åŠ¨ç”»æ·¡å…¥æ•ˆæœ
- è¾“å…¥æ¡†èšç„¦é«˜äº®
- é”™è¯¯æç¤ºé†’ç›®æ˜¾ç¤º
- åŠ è½½çŠ¶æ€åé¦ˆ

### iframe é¡µé¢
- å…¨å±æ˜¾ç¤º
- æ— è¾¹æ¡†æ— æ»šåŠ¨æ¡
- å®Œå…¨æ²‰æµ¸å¼ä½“éªŒ
- åŠ è½½åŠ¨ç”»

### å“åº”å¼è®¾è®¡
- ç§»åŠ¨ç«¯é€‚é…
- å¹³æ¿é€‚é…
- æ¡Œé¢ç«¯ä¼˜åŒ–

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **API éªŒè¯**ï¼šæ‰€æœ‰ API éƒ½éªŒè¯è¯·æ±‚æ–¹æ³•å’Œå‚æ•°
2. **SQL æ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
3. **XSS é˜²æŠ¤**ï¼šè¾“å…¥è‡ªåŠ¨è½¬ä¹‰
4. **HTTPS**ï¼šVercel è‡ªåŠ¨å¯ç”¨
5. **iframe Sandbox**ï¼šé™åˆ¶ä¸å®‰å…¨æ“ä½œ

## ğŸ“± è·¨å¹³å°æ”¯æŒ

- âœ… Chrome / Edge (æ¨è)
- âœ… Safari
- âœ… Firefox
- âœ… ç§»åŠ¨ç«¯æµè§ˆå™¨
- âœ… iPad / å¹³æ¿

## ğŸŒ GPTBots é›†æˆè¯´æ˜

### user_id çš„ä½œç”¨

æ ¹æ®è¡¥å……èµ„æ–™ï¼Œè®¾ç½® user_id åï¼š

1. **Tools è°ƒç”¨**ï¼šAgent è°ƒç”¨ Tools æ—¶ï¼Œuser_id åœ¨ Header ä¸­
2. **ç”¨æˆ·å±æ€§**ï¼šå±æ€§æ•°æ®å½’å±äºè¯¥ user_id
3. **å¯¹è¯æ—¥å¿—**ï¼šå¯¹è¯è®°å½•å½’å±äºè¯¥ user_id
4. **äº‹ä»¶å›è°ƒ**ï¼šGA4/webhook æºå¸¦è¯¥ä¿¡æ¯

### åŒ¿å ID ä¸ user_id

- **åŒ¿å ID**ï¼šiframe è‡ªåŠ¨ç”Ÿæˆï¼ˆæµè§ˆå™¨æŒ‡çº¹ï¼‰
- **user_id**ï¼šå¼€å‘è€…è®¾ç½®ï¼ˆæ‚£è€…é‚®ç®±ï¼‰
- **å…³è”**ï¼šåŒä¸€ user_id å¯ä»¥å…³è”å¤šä¸ªåŒ¿å IDï¼ˆè·¨è®¾å¤‡ï¼‰

### conversation_id ç”Ÿæˆ

```
user_id (é‚®ç®±) 
    â†“
è‡ªåŠ¨ç”Ÿæˆ conversation_id
    â†“
æ‰¿è½½å¯¹è¯å†…å®¹
```

## ğŸ¯ å®Œæˆçš„éœ€æ±‚

### âœ… éœ€æ±‚ä¸€ï¼šç®€æ´ iframe å±•ç¤º
- æ— å¯¼èˆªæ 
- å…¨å± iframe
- å±…ä¸­æ˜¾ç¤º

### âœ… éœ€æ±‚äºŒï¼šè½»é‡æ•°æ®åº“
- Vercel Postgresï¼ˆç”Ÿäº§ï¼‰
- æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¼€å‘ï¼‰
- å­˜å‚¨æ‚£è€…å®Œæ•´ä¿¡æ¯

### âœ… éœ€æ±‚ä¸‰ï¼šèº«ä»½éªŒè¯
- é‚®ç®± + ç”µè¯éªŒè¯
- éªŒè¯é€šè¿‡æ‰èƒ½è®¿é—®
- ç¾è§‚çš„ç™»å½•ç•Œé¢

### âœ… éœ€æ±‚å››ï¼šä¿¡æ¯ä¼ é€’
- é€šè¿‡ API è·å–æ‚£è€…ä¿¡æ¯
- URL å‚æ•°ä¼ é€’ user_id
- postMessage å‘é€å±æ€§
- Agent èƒ½è¯†åˆ«æ‚£è€…èº«ä»½

## ğŸ“ˆ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **ç”¨æˆ·å±æ€§ API**ï¼šé€šè¿‡ GPTBots API ä¸»åŠ¨æ¨é€ç”¨æˆ·å±æ€§
2. **ä¼šè¯ç®¡ç†**ï¼šæ·»åŠ ç™»å‡ºåŠŸèƒ½
3. **æ—¥å¿—è®°å½•**ï¼šè®°å½•ç”¨æˆ·è®¿é—®æ—¥å¿—
4. **å¤šè¯­è¨€**ï¼šæ”¯æŒè‹±æ–‡ç•Œé¢
5. **å¯†ç ä¿æŠ¤**ï¼šæ·»åŠ é¢å¤–çš„å¯†ç éªŒè¯å±‚

---

**å½“å‰ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-10  
**æ ¹æ®**ï¼šè¡¥å……èµ„æ–™.md

