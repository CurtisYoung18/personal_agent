# 🧪 測試指南

完整的測試流程和測試賬號。

---

## 📱 線上測試

**患者登入頁面**: https://your-vercel-url.vercel.app  
**管理後台**: https://your-vercel-url.vercel.app/admin

---

## ❓ 常見問題

### Q1: 管理後台在哪裡？
**A**: 在主域名後加 `/admin`  
例如：`https://your-project.vercel.app/admin`

### Q2: 為什麼連接了 Supabase 還能用測試賬號登入？
**A**: 系統設計了智能回退機制：
- 如果檢測到 `POSTGRES_URL` 環境變量，會嘗試連接真實數據庫
- 如果數據庫連接失敗或沒有數據，自動使用 `lib/db-mock.ts` 中的模擬數據
- 這樣可以確保在數據庫未初始化時系統仍可正常測試

**要使用真實數據庫**，需要：
1. 在 Supabase 或 Vercel Storage 中創建數據庫
2. 連接到 Vercel 項目（自動添加環境變量）
3. 在 Supabase SQL Editor 或 Vercel Storage Query 中運行 `sql/init.sql`
4. 重新部署項目

### Q3: Logo 在哪裡顯示？
**A**: Logo 只在患者登入頁面顯示，登入成功後不顯示（節省空間給 Agent 對話）

---

## 👤 測試賬號

### 患者登入測試

#### 1️⃣ 完整資料患者（葉問）

```
電話：99998888
電郵：yip.man@example.com
```

**預期結果**：
- ✅ 成功登入
- ✅ 跳轉到 Agent 對話頁面
- ✅ 頁首顯示：葉問 | 案例：20251010-001 | The Seafood House 10月8日晚宴
- ✅ 打開開發者工具 Console，看到：`✅ 用戶屬性已同步到 GPTBots`
- ✅ Agent 能夠識別患者姓名、年齡、職業等信息
- ✅ 刷新頁面會自動重新登入

---

#### 2️⃣ 僅電話登入（Lam Lok）

```
電話：97684471
電郵：（留空）
```

**預期結果**：
- ✅ 成功登入（無需電郵）
- ✅ 頁首顯示：Lam Lok | 案例：20251010-002
- ✅ Agent 知道用戶是 Lam Lok

---

#### 3️⃣ 特殊電話號碼（Pretty）

```
電話：1
電郵：Dm_hito@dh.gov.hk
```

**預期結果**：
- ✅ 成功登入
- ✅ 系統接受特殊電話號碼

---

#### 4️⃣ 其他測試患者

| 姓名 | 電話 | 電郵 |
|------|------|------|
| Shaun Wun | 55418888 | - |
| 凌兆楷 Wilfred | 66837316 | - |
| Venus | 64740051 | - |

---

### 管理後台測試

#### 🔐 管理員登入

```
URL：https://your-url.vercel.app/admin
用戶名：admin
密碼：admin123
```

**預期結果**：
- ✅ 成功登入管理後台
- ✅ 看到 6 個患者記錄
- ✅ 可以搜索患者（輸入姓名、電話、案例編號）
- ✅ 可以編輯患者信息
- ✅ 可以刪除患者
- ✅ 可以添加新患者

---

## 🧩 功能測試清單

### 1. 患者登入流程

- [ ] **有效電話登入**
  - 輸入：`99998888`
  - 預期：成功跳轉到對話頁面

- [ ] **無效電話登入**
  - 輸入：`00000000`
  - 預期：顯示「電話號碼或電郵不正確」

- [ ] **電話格式驗證**
  - 輸入：`12345`（少於8位）
  - 預期：顯示驗證錯誤

- [ ] **空白提交**
  - 不輸入任何內容，點擊登入
  - 預期：顯示「請輸入電話號碼」

---

### 2. Session 持久化測試

- [ ] **登入後刷新**
  - 登入後，刷新頁面（F5）
  - 預期：自動保持登入狀態，停留在對話頁面

- [ ] **關閉瀏覽器重開**
  - 登入後，關閉瀏覽器
  - 重新打開網站
  - 預期：自動登入

- [ ] **手動登出**
  - 點擊右上角「登出」按鈕
  - 預期：跳轉回登入頁面，session 清除

- [ ] **登出後刷新**
  - 登出後刷新登入頁面
  - 預期：停留在登入頁面，不會自動登入

---

### 3. GPTBots Agent 集成測試

- [ ] **Iframe 加載**
  - 登入後，iframe 正常顯示
  - 預期：看到 GPTBots 對話界面

- [ ] **User ID 傳遞**
  - 打開開發者工具 → Console
  - 查找：`user_id=20251010-001`（葉問的案例編號）
  - 預期：user_id 正確傳入 iframe URL

- [ ] **Email 傳遞**
  - 查找：`email=yip.man@example.com`
  - 預期：email 正確傳入 iframe URL

- [ ] **屬性同步**
  - Console 顯示：`✅ 用戶屬性已同步到 GPTBots`
  - 預期：詳細屬性（年齡、職業、症狀等）通過 API 同步

- [ ] **Agent 識別測試**
  - 在對話框輸入：「我是誰？」
  - 預期：Agent 回答「您是葉問」

- [ ] **多用戶隔離**
  - 登入葉問（99998888）
  - 登出，登入 Lam Lok（97684471）
  - 預期：Agent 正確識別不同用戶，互不干擾

---

### 4. 管理後台測試

- [ ] **管理員登入**
  - 使用 admin/admin123
  - 預期：進入管理後台

- [ ] **錯誤憑證**
  - 使用 admin/wrong_password
  - 預期：顯示「用戶名或密碼錯誤」

- [ ] **患者列表顯示**
  - 登入後台
  - 預期：看到 6 條患者記錄

- [ ] **搜索功能**
  - 輸入：「葉問」
  - 預期：只顯示葉問的記錄

- [ ] **編輯患者**
  - 點擊葉問的「編輯」按鈕
  - 修改年齡為 35
  - 保存
  - 預期：年齡更新成功

- [ ] **刪除患者**
  - 點擊某個患者的「刪除」按鈕
  - 確認刪除
  - 預期：記錄被刪除，列表更新

- [ ] **添加新患者**
  - 點擊「添加患者」
  - 輸入姓名、電話等必填項
  - 保存
  - 預期：新患者出現在列表中

---

## 🔍 Console 日誌檢查

打開開發者工具（F12），在 Console 標籤中應該看到：

### ✅ 正常日誌

```
🔐 自動登入中...
✅ 正在獲取患者信息...
✅ 用戶屬性已同步到 GPTBots
```

### ❌ 錯誤日誌（需修復）

```
❌ Error syncing properties with GPTBots
❌ Failed to fetch patient info
```

---

## 🌐 瀏覽器兼容性測試

測試以下瀏覽器：

- [ ] Chrome/Edge（最新版）
- [ ] Safari（macOS/iOS）
- [ ] Firefox（最新版）
- [ ] Mobile Safari（iPhone）
- [ ] Mobile Chrome（Android）

---

## 📊 性能測試

- [ ] **頁面加載速度**
  - 登入頁面 < 2秒
  - 對話頁面 < 3秒

- [ ] **Iframe 加載**
  - GPTBots iframe < 5秒

- [ ] **API 響應時間**
  - 登入驗證 < 500ms
  - 屬性同步 < 1秒

---

## 🐛 已知問題

*(目前無已知問題)*

---

## ✅ 測試完成檢查表

部署後必須完成以下測試：

- [ ] 患者可以使用電話號碼成功登入
- [ ] 刷新頁面保持登入狀態
- [ ] Agent 正確識別不同患者
- [ ] Console 顯示屬性同步成功
- [ ] 管理員可以登入後台
- [ ] 後台可以執行 CRUD 操作
- [ ] 手機端正常訪問和操作
- [ ] 登出功能正常工作

---

## 🆘 故障排查

### 問題 1：無法登入

**症狀**：輸入正確電話號碼但無法登入

**檢查**：
1. 數據庫是否正確初始化？運行 `sql/init.sql`
2. 環境變量是否配置？檢查 `POSTGRES_URL`
3. Console 是否有錯誤訊息？

---

### 問題 2：Agent 無法識別用戶

**症狀**：Agent 不知道用戶是誰

**檢查**：
1. Console 是否顯示「屬性已同步」？
2. `GPTBOTS_API_KEY` 是否正確配置？
3. iframe URL 是否包含 `user_id` 和 `email` 參數？

---

### 問題 3：刷新後需要重新登入

**症狀**：頁面刷新後跳回登入頁面

**檢查**：
1. 瀏覽器是否允許 localStorage？
2. 是否在隱私模式下訪問？

---

## 📞 支援

測試過程中發現問題？請記錄：
- 瀏覽器版本
- 操作步驟
- 錯誤訊息
- Console 日誌截圖

---

**測試愉快！** 🎉

